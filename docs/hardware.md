# Hardware Technical Documentation

## 1. System Overview
The system consists of a base board that interconnects 5 ESP32 modules in a ring configuration, designed to be part of a larger mesh network. Each node can function as either a regular node or a root node and is intended to provide WiFi connectivity at a household level.

## 2. Main Components
### 2.1 ESP32 Modules
- Quantity: 5 modules per node
- Roles: North, South, East, West, AP (Access Point)
- Power Supply: 5V
- Configuration: Through dedicated pins

### 2.2 Pinout

![alt text](./esp32-devkitC-v4-pinout.png)

### 2.3 Role Configuration System
**Configuration Pins:**
- CONFIG_PIN_0: GPIO 22 (least significant bit)
- CONFIG_PIN_1: GPIO 21
- CONFIG_PIN_2: GPIO 16 (most significant bit)


**Configuration Table:**
| CONFIG_PIN_2 | CONFIG_PIN_1 | CONFIG_PIN_0 | Mode/Orientation |
|--------------|--------------|--------------|------------------|
| 0 | 0 | 0 | North |
| 0 | 0 | 1 | South |
| 0 | 1 | 0 | East |
| 0 | 1 | 1 | West |
| 1 | 0 | 0 | Access Point |
| 1 | 0 | 1 | Root |

**Circuit**

All GPIO pins feature internal pull-up resistors.

For example to config West Board:

![alt text](./arquitectura-pullup.svg)

## 3. SPI Interconnections

### 3.1 SPI Protocol Overview
SPI (Serial Peripheral Interface) is a synchronous serial communication protocol that operates in full-duplex mode. It uses a master-slave architecture where the master device initiates the communication.

#### Key Characteristics:
- Full-duplex communication (simultaneous send and receive)
- Synchronous protocol (uses a clock signal)
- Master-slave architecture
- Can achieve high data transfer rates
- No built-in acknowledgment mechanism
- No built-in flow control

### 3.2 SPI Signal Lines
The SPI bus consists of four fundamental signals:

1. **MOSI (Master Out Slave In)**:
   - Data line from master to slave
   - Carries data being sent from the master to the slave
   - Data is shifted out on one clock edge and sampled on the opposite edge

2. **SCLK (Serial Clock)**:
   - Generated by the master device
   - Synchronizes data transmission
   - Determines the speed of data transfer
   - In our implementation: GPIO 18 (Master) → GPIO 14 (Slave)
   - Typical frequencies range from a few MHz to tens of MHz

3. **CS (Chip Select)** or SS (Slave Select):
   - Active-low signal that enables/disables slave devices
   - Essential even in single-slave configurations for:
     * Synchronization: Marks the start and end of data transmission
     * Initialization: Helps slave reset its internal logic
     * Error Control: Allows recovery from communication errors
   - In our implementation: GPIO 5 (Master) → GPIO 15 (Slave)
   
   Example of CS importance in data framing:
   ```
   With CS:
   CS    ‾‾\_____/‾‾\_____/‾‾
   SCLK  ‾‾‾█████‾‾‾‾█████‾‾‾
   MOSI  ‾‾‾DATA1‾‾‾‾DATA2‾‾‾
   
   Without CS:
   SCLK  ‾‾██████████████‾‾‾
   MOSI  ‾‾DATA1DATA2****‾‾‾
   ```
   CS ensures proper message framing and synchronization

4. **MISO (Master In Slave Out) - Not used**:
   - Data line from slave to master
   - Not used in our current implementation as we use unidirectional communication

### 3.3 Ring Configuration Implementation
In our system, the ring configuration means:
```
North ESP32 → East ESP32 → South ESP32 → AP ESP32 → West ESP32 → North ESP32
```
![alt text](./arquitectura-conexiones-nodo.svg)

Each ESP32 acts as:
- Master for its clockwise neighbor
- Slave for its counterclockwise neighbor

### 3.4 Timing Diagram
```
CS    ‾‾\_____________/‾‾
SCLK  ‾‾\_/‾\_/‾\_/‾\_/‾‾
MOSI  ‾‾\_DATA   BITS_/‾‾‾‾
```

### 3.5 Implementation Details
**Pin Configuration:**
```
Master Device          Slave Device
-------------         -------------
GPIO 23 (MOSI)  ────► GPIO 13 (MOSI)
GPIO 18 (SCLK)  ────► GPIO 14 (SCLK)
GPIO 5  (CS)    ────► GPIO 15 (CS)
```

**Communication Process:**
1. Master pulls CS low to initiate communication
2. Master generates clock signal on SCLK
3. Data is transmitted on MOSI line synchronized with SCLK
4. After data transfer, master pulls CS high

## 4. Electrical Specifications
### 4.1 Power Supply
- Input Voltage: 5V via USB or 5v source (PENDING: Add current)

### 4.2 Digital Signals

## 5. Design Considerations
### 5.1 Software
- Operating System: FreeRTOS
- Programming: Via USB interface
- Booting: Custom handling via FreeRTOS
